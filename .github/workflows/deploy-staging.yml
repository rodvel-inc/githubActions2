name: Auto-Deploy a Staging

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI - Test and Build"]
    types:
      - completed
    #inputs:
    #  ref:
    #    description: "Rama a desplegar"
    #    required: true
    #    default: "develop"
      
  #workflow_run:
  #  workflows: ["CI - Test and Build"]
  #  types:
  #    - completed
  #  branches: [develop]

jobs:
  deploy-staging:
    runs-on: [self-hosted]
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4
        #with:
        #  repository: ${{ github.repository }} # El repo actual
        #  ref: ${{ github.event.inputs.ref }} # La rama enviada desde ci.yml
        #  token: ${{ secrets.GITHUB_TOKEN }} # El GITHUB_TOKEN est√°ndar es suficiente para clonar el propio repo
          

      - name: üê≥ Login a Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: üì¶ Traer im√°genes m√°s recientes
        run: |
          docker pull rodvelinc/vote:latest
          docker pull rodvelinc/result:latest
          docker pull rodvelinc/worker:latest

      - name: üöÄ Despliegue a Staging
        run: docker compose -f docker-compose.staging.yml up -d

      - name: ‚è≥ Esperar a que los servicios est√©n listos
        run: |
          chmod +x ./scripts/wait-for-services.sh
          ./scripts/wait-for-services.sh

      - name: Asegurar permisos del script de smoke tests
        run: chmod +x ./scripts/integrationTest.sh
      
      - name: üß™ Ejecutar pruebas de humo
        run: ./scripts/integrationTest.sh

      - name: Tear down
        if: always()
        run: docker compose down
